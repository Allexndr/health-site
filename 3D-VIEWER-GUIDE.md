# 3D Просмотрщик OneVolumeViewer - Руководство

## Обзор
Профессиональная платформа для анализа стоматологических 3D снимков, специально разработанная для работы с архивами OneVolumeViewer. Система обрабатывает проприетарные .vol файлы и извлекает метаданные пациентов для медицинского анализа.

## Поддерживаемые форматы

### OneVolumeViewer архивы (.CT, .zip)
- **CT_0.vol** - основные данные объема (до 2 ГБ)
- **ver_ctrl.txt** - метаданные пациента и параметры сканирования
- **VolumeId.xml** - технические параметры объема
- **CtTaskId.jmd** - дополнительные метаданные сканирования
- **bin/** - исполняемые файлы OneVolumeViewer (опционально)

### Структура архива
```
Пациент_YYYYMMDDHHMMSS.CT/
├── ver_ctrl.txt                 # Данные пациента
├── CT_YYYYMMDDHHMMSS/          # Папка с данными томографии
│   ├── CT_0.vol                # Основной файл объема (611MB+)
│   ├── VolumeId.xml            # Параметры объема
│   ├── CtTaskId.jmd            # Метаданные сканирования
│   ├── CMPR_0.xml              # Параметры сжатия
│   └── Constants.csv           # Константы реконструкции
└── bin/                        # Исполняемые файлы (опционально)
    └── x64/
        └── OneVolumeViewer.exe
```

## Технические характеристики

### Парсинг метаданных пациента
Автоматическое извлечение из ver_ctrl.txt:
- ID пациента
- ФИО (разделенное на компоненты)
- Дата рождения
- Пол
- Дата сканирования
- CT Task ID
- Параметры сканирования

### Объемные данные
- **Формат**: Проприетарный .vol файл OneVolumeViewer
- **Тип данных**: 16-bit объемные данные
- **Структура**: Кубические объемы с переменным размером
- **Расчет размеров**: На основе радиуса объема и размера вокселя
- **Максимальный размер**: До 2 ГБ на архив

### Рендеринг
- **WebGL**: Аппаратное ускорение для производительности
- **CPU Fallback**: Автоматический переход при отсутствии WebGL
- **Формат отображения**: Slice-based просмотр с навигацией по срезам
- **Window/Level**: Настраиваемые предустановки для разных тканей

## Архитектура компонентов

### Upload3D.tsx
Обрабатывает загрузку и парсинг OneVolumeViewer архивов:

```typescript
interface OneVolumeData {
  patientInfo: PatientInfo | null    // Данные из ver_ctrl.txt
  volumeInfo: VolumeInfo | null      // Параметры из VolumeId.xml
  volumeData: ArrayBuffer | null     // Сырые данные из CT_0.vol
  isValid: boolean
  error?: string
}
```

**Ключевые функции:**
- `parseVerCtrlFile()` - Извлечение данных пациента
- `parseVolumeIdXml()` - Анализ параметров объема
- `processOneVolumeArchive()` - Основная обработка архива

### Viewer3D.tsx
Рендерит объемные данные в браузере:

**Основные возможности:**
- Расчет размеров объема на основе радиуса и voxel size
- WebGL текстуры для эффективного рендеринга
- Slice navigation с Window/Level контролями
- Отображение метаданных пациента

**Методы визуализации:**
- `calculateVolumeDimensions()` - Вычисление размеров на основе .vol данных
- `renderSlice()` - Рендеринг отдельного среза с применением Window/Level
- `handleWindowChange()` - Динамическое изменение контрастности

### Tools3D.tsx
Профессиональные инструменты анализа:
- Window/Level presets для разных типов тканей
- Измерительные инструменты
- Настройки яркости и контрастности
- Навигация по срезам

## Примеры использования

### Загрузка OneVolumeViewer архива
```javascript
// Пользователь выбирает .CT файл
const handleFilesSelected = (data: OneVolumeData) => {
  if (data.isValid) {
    console.log('Пациент:', data.patientInfo?.name)
    console.log('Радиус объема:', data.volumeInfo?.radius, 'мм')
    console.log('Размер данных:', data.volumeData?.byteLength, 'байт')
  }
}
```

### Извлечение метаданных пациента
```javascript
// Автоматический парсинг ver_ctrl.txt
const patientInfo = {
  name: "Anel Aiyanovna Ibragimova",
  id: "000000012658", 
  birthDay: "19950526",
  photoDate: "20250718102232",
  ctTaskId: "1.2.392.00200036.9133.3.1.990002.3.20250718102233192"
}
```

### Анализ параметров объема
```javascript
// Данные из VolumeId.xml
const volumeInfo = {
  radius: 44,                    // мм
  voxelSize: 0.125,             // мм
  reconstructionFilter: "G_003+H_205",
  center: { x: 0, y: 0, z: 0 }
}
```

## Производительность

### Оптимизации
- **Динамический импорт**: JSZip загружается только при необходимости
- **Streaming обработка**: Большие файлы обрабатываются порциями
- **WebGL рендеринг**: Аппаратное ускорение для плавной навигации
- **Кэширование текстур**: Переиспользование данных для быстрого переключения

### Ограничения
- **Размер файла**: Максимум 2 ГБ на архив
- **Память браузера**: Требуется достаточно RAM для больших объемов
- **WebGL поддержка**: Современные браузеры для полной функциональности

## Безопасность и приватность

### Локальная обработка
- Все данные обрабатываются локально в браузере
- Никакой передачи медицинских данных на серверы
- Полная конфиденциальность пациентов

### Очистка памяти
- Автоматическое освобождение ArrayBuffer после использования
- Очистка WebGL контекстов при смене файлов
- Garbage collection для больших объемов данных

## Совместимость

### Браузеры
- **Chrome 90+**: Полная поддержка WebGL2
- **Firefox 88+**: WebGL и динамические импорты
- **Safari 14+**: Базовая функциональность
- **Edge 90+**: Полная совместимость

### Требования к системе
- **RAM**: Минимум 4 ГБ для файлов >500 МБ
- **GPU**: Интегрированная графика или лучше
- **CPU**: Современный многоядерный процессор

## Устранение неполадок

### Частые проблемы

**"ZIP архив не содержит .vol файлов"**
- Проверьте структуру архива
- Убедитесь, что присутствует папка CT_* с файлом CT_0.vol

**"WebGL не поддерживается"**
- Обновите браузер до последней версии
- Проверьте настройки аппаратного ускорения
- Используйте другой браузер

**"Недостаточно памяти"**
- Закройте другие вкладки браузера
- Используйте файлы меньшего размера
- Перезапустите браузер

### Диагностика
```javascript
// Проверка WebGL поддержки
const canvas = document.createElement('canvas')
const gl = canvas.getContext('webgl2') || canvas.getContext('webgl')
console.log('WebGL поддерживается:', !!gl)

// Проверка размера архива
console.log('Размер файла:', file.size, 'байт')
console.log('Лимит:', 2 * 1024 * 1024 * 1024, 'байт') // 2GB
```

## Будущие улучшения

### Планируемые функции
- **MPR реконструкции**: Многоплоскостные реформатирования
- **3D Volume Rendering**: Полноценный 3D рендеринг вместо slice-based
- **DICOM экспорт**: Конвертация .vol данных в стандартный DICOM
- **Измерительные инструменты**: Расстояния, углы, площади
- **Аннотации**: Профессиональные пометки на снимках

### Техническая дорожная карта
- Интеграция с WebAssembly для обработки больших объемов
- Поддержка WebGPU для более быстрого рендеринга
- Оффлайн кэширование для часто используемых архивов
- Интеграция с PACS системами больниц

---

## Поддержка

Для технической поддержки или сообщения об ошибках:
- Проверьте консоль браузера на наличие ошибок
- Убедитесь в корректности формата OneVolumeViewer архива
- Попробуйте другой браузер или файл меньшего размера 
 

## Обзор
Профессиональная платформа для анализа стоматологических 3D снимков, специально разработанная для работы с архивами OneVolumeViewer. Система обрабатывает проприетарные .vol файлы и извлекает метаданные пациентов для медицинского анализа.

## Поддерживаемые форматы

### OneVolumeViewer архивы (.CT, .zip)
- **CT_0.vol** - основные данные объема (до 2 ГБ)
- **ver_ctrl.txt** - метаданные пациента и параметры сканирования
- **VolumeId.xml** - технические параметры объема
- **CtTaskId.jmd** - дополнительные метаданные сканирования
- **bin/** - исполняемые файлы OneVolumeViewer (опционально)

### Структура архива
```
Пациент_YYYYMMDDHHMMSS.CT/
├── ver_ctrl.txt                 # Данные пациента
├── CT_YYYYMMDDHHMMSS/          # Папка с данными томографии
│   ├── CT_0.vol                # Основной файл объема (611MB+)
│   ├── VolumeId.xml            # Параметры объема
│   ├── CtTaskId.jmd            # Метаданные сканирования
│   ├── CMPR_0.xml              # Параметры сжатия
│   └── Constants.csv           # Константы реконструкции
└── bin/                        # Исполняемые файлы (опционально)
    └── x64/
        └── OneVolumeViewer.exe
```

## Технические характеристики

### Парсинг метаданных пациента
Автоматическое извлечение из ver_ctrl.txt:
- ID пациента
- ФИО (разделенное на компоненты)
- Дата рождения
- Пол
- Дата сканирования
- CT Task ID
- Параметры сканирования

### Объемные данные
- **Формат**: Проприетарный .vol файл OneVolumeViewer
- **Тип данных**: 16-bit объемные данные
- **Структура**: Кубические объемы с переменным размером
- **Расчет размеров**: На основе радиуса объема и размера вокселя
- **Максимальный размер**: До 2 ГБ на архив

### Рендеринг
- **WebGL**: Аппаратное ускорение для производительности
- **CPU Fallback**: Автоматический переход при отсутствии WebGL
- **Формат отображения**: Slice-based просмотр с навигацией по срезам
- **Window/Level**: Настраиваемые предустановки для разных тканей

## Архитектура компонентов

### Upload3D.tsx
Обрабатывает загрузку и парсинг OneVolumeViewer архивов:

```typescript
interface OneVolumeData {
  patientInfo: PatientInfo | null    // Данные из ver_ctrl.txt
  volumeInfo: VolumeInfo | null      // Параметры из VolumeId.xml
  volumeData: ArrayBuffer | null     // Сырые данные из CT_0.vol
  isValid: boolean
  error?: string
}
```

**Ключевые функции:**
- `parseVerCtrlFile()` - Извлечение данных пациента
- `parseVolumeIdXml()` - Анализ параметров объема
- `processOneVolumeArchive()` - Основная обработка архива

### Viewer3D.tsx
Рендерит объемные данные в браузере:

**Основные возможности:**
- Расчет размеров объема на основе радиуса и voxel size
- WebGL текстуры для эффективного рендеринга
- Slice navigation с Window/Level контролями
- Отображение метаданных пациента

**Методы визуализации:**
- `calculateVolumeDimensions()` - Вычисление размеров на основе .vol данных
- `renderSlice()` - Рендеринг отдельного среза с применением Window/Level
- `handleWindowChange()` - Динамическое изменение контрастности

### Tools3D.tsx
Профессиональные инструменты анализа:
- Window/Level presets для разных типов тканей
- Измерительные инструменты
- Настройки яркости и контрастности
- Навигация по срезам

## Примеры использования

### Загрузка OneVolumeViewer архива
```javascript
// Пользователь выбирает .CT файл
const handleFilesSelected = (data: OneVolumeData) => {
  if (data.isValid) {
    console.log('Пациент:', data.patientInfo?.name)
    console.log('Радиус объема:', data.volumeInfo?.radius, 'мм')
    console.log('Размер данных:', data.volumeData?.byteLength, 'байт')
  }
}
```

### Извлечение метаданных пациента
```javascript
// Автоматический парсинг ver_ctrl.txt
const patientInfo = {
  name: "Anel Aiyanovna Ibragimova",
  id: "000000012658", 
  birthDay: "19950526",
  photoDate: "20250718102232",
  ctTaskId: "1.2.392.00200036.9133.3.1.990002.3.20250718102233192"
}
```

### Анализ параметров объема
```javascript
// Данные из VolumeId.xml
const volumeInfo = {
  radius: 44,                    // мм
  voxelSize: 0.125,             // мм
  reconstructionFilter: "G_003+H_205",
  center: { x: 0, y: 0, z: 0 }
}
```

## Производительность

### Оптимизации
- **Динамический импорт**: JSZip загружается только при необходимости
- **Streaming обработка**: Большие файлы обрабатываются порциями
- **WebGL рендеринг**: Аппаратное ускорение для плавной навигации
- **Кэширование текстур**: Переиспользование данных для быстрого переключения

### Ограничения
- **Размер файла**: Максимум 2 ГБ на архив
- **Память браузера**: Требуется достаточно RAM для больших объемов
- **WebGL поддержка**: Современные браузеры для полной функциональности

## Безопасность и приватность

### Локальная обработка
- Все данные обрабатываются локально в браузере
- Никакой передачи медицинских данных на серверы
- Полная конфиденциальность пациентов

### Очистка памяти
- Автоматическое освобождение ArrayBuffer после использования
- Очистка WebGL контекстов при смене файлов
- Garbage collection для больших объемов данных

## Совместимость

### Браузеры
- **Chrome 90+**: Полная поддержка WebGL2
- **Firefox 88+**: WebGL и динамические импорты
- **Safari 14+**: Базовая функциональность
- **Edge 90+**: Полная совместимость

### Требования к системе
- **RAM**: Минимум 4 ГБ для файлов >500 МБ
- **GPU**: Интегрированная графика или лучше
- **CPU**: Современный многоядерный процессор

## Устранение неполадок

### Частые проблемы

**"ZIP архив не содержит .vol файлов"**
- Проверьте структуру архива
- Убедитесь, что присутствует папка CT_* с файлом CT_0.vol

**"WebGL не поддерживается"**
- Обновите браузер до последней версии
- Проверьте настройки аппаратного ускорения
- Используйте другой браузер

**"Недостаточно памяти"**
- Закройте другие вкладки браузера
- Используйте файлы меньшего размера
- Перезапустите браузер

### Диагностика
```javascript
// Проверка WebGL поддержки
const canvas = document.createElement('canvas')
const gl = canvas.getContext('webgl2') || canvas.getContext('webgl')
console.log('WebGL поддерживается:', !!gl)

// Проверка размера архива
console.log('Размер файла:', file.size, 'байт')
console.log('Лимит:', 2 * 1024 * 1024 * 1024, 'байт') // 2GB
```

## Будущие улучшения

### Планируемые функции
- **MPR реконструкции**: Многоплоскостные реформатирования
- **3D Volume Rendering**: Полноценный 3D рендеринг вместо slice-based
- **DICOM экспорт**: Конвертация .vol данных в стандартный DICOM
- **Измерительные инструменты**: Расстояния, углы, площади
- **Аннотации**: Профессиональные пометки на снимках

### Техническая дорожная карта
- Интеграция с WebAssembly для обработки больших объемов
- Поддержка WebGPU для более быстрого рендеринга
- Оффлайн кэширование для часто используемых архивов
- Интеграция с PACS системами больниц

---

## Поддержка

Для технической поддержки или сообщения об ошибках:
- Проверьте консоль браузера на наличие ошибок
- Убедитесь в корректности формата OneVolumeViewer архива
- Попробуйте другой браузер или файл меньшего размера 
 
 
 
 
 
 
 
 
 
 
 